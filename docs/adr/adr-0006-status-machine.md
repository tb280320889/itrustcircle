# ADR-0006：Guardian 状态机（断联→倒计时→上报）

## 状态

待定

## 背景

Sentinel 的核心功能是守护 BLE 连接状态，需要在断联时触发倒计时，并在无人取消时生成 AlertEvent 上报。需要定义清晰的状态转移规则和可观测的行为模式。

## 决策（待定）

### 候选状态集合

1. **idle**（空闲）
   - 初始状态，未开始守护
   - 转移条件：用户点击"开始守护" → connecting

2. **connecting**（连接中）
   - 正在与 BLE 设备建立连接
   - 转移条件：连接成功 → guarding；连接失败 → idle（可重试）

3. **guarding**（守护中）
   - 正在监听 BLE 连接状态，不做高频扫描
   - 转移条件：检测到断联 → countdown；用户主动停止 → idle

4. **countdown**（倒计时中）
   - BLE 断联，进入倒计时缓冲期（默认 30s，可配置）
   - 转移条件：用户取消 → guarding；倒计时结束 → reporting

5. **reporting**（上报中）
   - 生成 AlertEvent 并尝试上报到 Tower
   - 转移条件：上报成功 → guarding；网络失败 → queuing

6. **queuing**（队列中）
   - 网络不可达，事件进入离线队列等待补发
   - 转移条件：网络恢复且重试成功 → guarding；重试失败 → queuing（退避）

### 关键行为定义

- **防抖策略**：N 秒内重复断联只触发一次倒计时
- **幂等上报**：同一事件不会重复生成 AlertEvent
- **可观测性**：每个状态转移都有日志记录和 UI 反馈

## 验证方式（可执行）

1. **状态转移测试**：
   - 手动断开 BLE → 验证进入 countdown 状态
   - 倒计时内取消 → 验证返回 guarding 状态
   - 倒计时结束 → 验证进入 reporting 状态
   - 断网状态下触发 → 验证进入 queuing 状态

2. **防抖测试**：
   - 快速断开/连接 BLE 多次 → 验证只触发一次倒计时
   - 调整 Profile 参数 → 验证倒计时时间相应变化

3. **日志追踪**：
   - 状态转移事件写入日志
   - 可通过诊断导出查看状态历史

4. **Failure Modes 覆盖**：
   - 网络失败状态（queuing → guarding）
   - 权限不足状态（guarding → idle 强制转移）
   - 系统杀死恢复状态（idle 重新初始化）