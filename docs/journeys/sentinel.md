# Sentinel 用户旅程（MVP）

## A. 目标与范围

### A1. 用户目标
- 绑定 Tower + 选择 BLE 设备并后台守护：断联进入倒计时，未取消则上报报警事件。

### A2. 成功定义
- BLE 断联后：倒计时弹出；未取消 → 生成 AlertEvent → 成功上报或进入离线队列等待补发。

## B. 参与者与前置条件

### B1. 参与者
- Sentinel（主）、Tower（接收与通知）、Contact（被通知）

### B2. 前置条件
- 已获得关键权限：蓝牙相关、（Android 扫描/定位需要时）定位、前台服务/通知（用于后台稳定）。
- Tower 可达（局域网/穿透/公网之一，由 ADR 决策）。

## C. 主流程（Happy Path）

### C1. 绑定与启用守护
1. 打开 App → 选择「Sentinel 模式」
2. 扫码绑定 Tower（tower_id/endpoint/token）
3. 选择 Profile（Child/Elder/Pet/Custom）→ 确认倒计时秒数等参数
4. 选择并连接 BLE 设备 → 显示连接状态与信号
5. 进入「守护中」：后台持续监听连接状态（不做高频扫描）

### C2. 断联触发链路
1. BLE 断联 → 进入「倒计时缓冲」UI/通知（震动+倒计时）
2. 用户在倒计时内取消 → 记录一次“误报取消”（用于调参）
3. 倒计时结束未取消 → 生成 AlertEvent（最小字段）→ 发送到 Tower
4. 发送成功：记录投递结果；继续守护（或进入事件后续状态，由 ADR 决定）

## D. 备选/分支流程

### D1. Tower 不可达/无网
- AlertEvent 进入离线队列；网络恢复后自动补发（指数退避+最大次数）。

### D2. 防抖与误报
- N 秒内重复断联只算一次；可在 Profile 调整倒计时/阈值（MVP 先断联+buffer）。

## E. 失败模式与恢复

### E1. 权限不足/系统省电杀后台
- 权限自检必须阻断“开始守护”（至少蓝牙/前台服务/通知）。
- 提供“一键修复指引”：跳转系统设置 + 省电策略提醒。

### E2. BLE 设备自身不稳定
- 误报取消记录可追踪；引导用户延长倒计时/调整设备佩戴与电量。

## F. 验收与测试点

### F1. 验收点（实现驱动）
- F1.1：断联必进倒计时；倒计时可取消且会写入日志/记录。
- F1.2：未取消则必生成 AlertEvent（含 event_id、timestamp、trigger_reason、device_meta）。
- F1.3：无网时队列持久化；恢复网络后可补发成功。

### F2. 手动检查步骤（后续 acceptance 可引用）
1. 绑定 Tower → 选择 BLE → 开始守护
2. 手动关闭 BLE 设备或拉远断联 → 验证倒计时出现
3. 测试取消：倒计时内取消后不应上报；记录误报条目
4. 测试触发：不取消 → Tower 收到事件并通知成功
5. 测试断网：断网触发 → 恢复网络后自动补发
