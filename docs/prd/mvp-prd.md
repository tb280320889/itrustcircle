# iTrustCircle MVP PRD

## 1. 背景与问题

### 1.1 背景

- 现有手机/手表 SOS 多为主动触发（按键/连按电源），在“突发失能 / 被抢手机 / 无法操作”的场景覆盖不足。

- iTrustCircle 主打被动触发：基于“BLE 断联”与“倒计时无人取消”的链路完成预警与通知。

- MVP 聚焦：稳定、低心智、低功耗地把“断联 → 倒计时 → 上报 → 通知信任人”跑通。

### 1.2 待解决问题（Problem Statements）

- P1：如何在 手机锁屏/后台/弱网 情况下，仍能可靠检测 BLE 断联并触发倒计时（尽量少误报）
- P2：倒计时无人取消时，如何确保 AlertEvent 可投递（离线队列 + 重试 + 恢复后补发）。
- P3：塔台端如何做到 接收/存档/通知可观测（SQLite、投递记录、状态页、诊断导出）。

## 2. 目标（Goals）

- G1：用三条用户旅程定义 MVP 的最小闭环（Tower/Sentinel/Contact）
- G2：把核心失败模式与恢复策略文档化，避免“实现时才发现缺口”
- G3：将至少 8 条关键决策以 ADR 固化，标明待定/已定与验证方式

## 3. 非目标（Non-Goals）

- 不引入复杂权限体系或多端同步体系（除非 ADR 决策要求）
- 不做跨层大改（跨层必须拆卡，且不在本轮实现）

## 4. 用户与场景

### 4.1 角色（MVP）

- Tower：塔台设备（家里旧手机/平板）。接收 AlertEvent、SQLite 存档、触发通知策略（MVP：Email）。
- Sentinel：哨兵设备（随身手机，未来可扩展 WearOS）。监测 BLE 连接、断联触发倒计时、用户未取消则上报塔台。
- Contact：紧急联系人（不做独立 App）。通过邮件/IM/短信等收到强提醒并按指引行动。

### 4.2 假设（可被推翻）

- H1：移动端单应用可覆盖 MVP（无需 Web 端）
- H2：第一轮以 Android 为主平台

## 5. 范围（Scope）

### 5.1 In Scope

- 被动触发主链路：BLE 断联 → 倒计时缓冲 → 用户可取消 → 未取消生成 AlertEvent
- 可靠投递：哨兵端离线队列 + 指数退避重试 + 网络恢复自动补发
- 塔台接收与存档：POST /api/alerts 接收 → SQLite 落库（事件/投递记录/配置）
- 通知策略（至少 1 条可用）：MVP 必做 Email（SMTP）；可选 Telegram（GLOBAL）
- 可观测与自检：状态页、最近 N 次事件列表、投递结果、诊断导出（日志 + 配置摘要）
- 文档与验收：PRD / Journeys / Failure Modes / ADR / Acceptance 与实现保持一致（跟随版本）

### 5.2 Out of Scope

- 实时视频/音频推流、取证固化（区块链/去中心化存储）
- 群体互助联邦中继/公共转发（Relay）
- Apple Watch 原生、复杂多端同步
- 付费短信/语音电话（可作为后续 Pro）

## 6. 需求（Requirements）

### 6.1 功能需求（按旅程拆分）

- 以 [用户旅程](../journeys/README.md) 为准，每条旅程的 F 章给出验收点
- R1（P0）哨兵端可选择并绑定一个 BLE 设备，进入“守护中”状态
- R2（P0）检测到 BLE 断联后进入倒计时（默认 30s，可配置），倒计时内可快速取消并记录“误报取消”
- R3（P0）倒计时结束未取消：生成最小 AlertEvent 并上报塔台
- R4（P0）弱网/断网：事件进入本地队列；网络恢复后自动补发；重试有上限与退避
- R5（P0）塔台端接收事件并 SQLite 存档；提供最近事件列表与详情
- R6（P0）塔台触发通知：Email 必须可用；投递结果可查询（成功/失败/重试）
- R7（P0）诊断导出：最近日志 + 配置摘要（用于排障与复现）
- R8（P0）权限自检向导：蓝牙/定位/通知/后台运行（缺项明确提示与引导）

### 6.2 非功能需求（NFR）

- 可靠性：Guardian Core > UI（UI 崩溃不影响核心链路继续运行）
- 功耗：默认只监测连接状态；不做高频扫描；倒计时与重试策略需可配置
- 安全与隐私：最小采集（时间/位置/设备元信息）；传输加密；塔台与哨兵认证（细节进 ADR）
- 可观测：链路每一段都有可追踪记录（事件、队列、投递）

## 7. 度量（Success Metrics）

- M1：在目标设备上（Android 6+）锁屏/后台场景下，断联 能触发倒计时（在合理权限与设置下）
- M2：弱网/断网场景下，AlertEvent 不会丢失，恢复网络后 可补发成功
- M3：通知到达率：Email 在测试环境下可稳定送达（投递结果可追踪）
- M4：误报可控：重复断联在防抖策略下不会频繁报警（具体阈值写入 Profile/ADR）
- M5：可排障：一次失败能通过“诊断导出”复现/定位原因

## 8. 约束与依赖

- 技术约束：apps/mobile（SvelteKit + Capacitor v7 Android）
- 版本底线：Android API 23+
- 当前 Sprint 0/1：允许只改 docs；但 PRD 的 Scope/Requirements 必须对应未来实现闭环

## 9. 开放问题（Open Questions）

- OQ1：断联判定策略：仅断联事件 + buffer，还是叠加 RSSI 阈值/持续时间（MVP vs v1.1）
- OQ2：定位权限不足时的降级：是否允许无位置上报？UI 如何提示风险（写入 ADR）
- OQ3：塔台可达性：局域网直连 vs 穿透/域名（MVP 先选哪条最可控）
- OQ4：幂等与去重：事件 ID、重放语义、塔台去重策略（ADR-0008）
- OQ5：通知通道优先级与失败回退策略（Email/Telegram/未来短信）