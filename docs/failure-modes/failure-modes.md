# Failure Modes（MVP）

## 1. 范围与原则

- 覆盖对象：三条用户旅程（Tower/Sentinel/Contact）的关键失败点
- 目标：定义可观测、可恢复、可验收的最小处理策略
- 原则：Guardian Core 可靠性 > UI，核心链路不能因 UI 崩溃而中断

## 2. 失败模式分类（MVP）

### 2.1 网络与设备

- FM-N1：无网络（Sentinel 上报失败 / Tower 通知失败）
- FM-N2：弱网/高延迟（上报超时 / 通知投递延迟）
- FM-N3：应用被系统杀死后恢复（Android 省电策略 / 后台限制）
- FM-N4：BLE 设备自身不稳定（频繁断联 / 连接异常）

### 2.2 数据一致性

- FM-D1：本地草稿与已发送状态不一致（离线队列状态混乱）
- FM-D2：重复发送导致重复事件（网络重试 / 用户重复操作）
- FM-D3：Tower 端事件去重失败（重复落库 / 重复通知）

### 2.3 用户与交互

- FM-U1：权限不足导致功能受限（蓝牙/定位/通知/后台权限）
- FM-U2：误报取消记录缺失（无法调参 / 误报统计不准确）
- FM-U3：配置信息不完整（Tower 未配置通知 / Sentinel 未绑定 BLE）

## 3. Failure Mode 条目模板

每个条目至少包含：

- 触发条件
- 用户可见症状
- 影响范围
- 检测方式（日志/埋点/界面提示）
- 缓解与恢复策略
- 验收方式（可执行步骤）

## 4. MVP 条目（详细版）

### 4.1 FM-N1：无网络

**场景 A：Sentinel 无网上报失败**
- 触发条件：BLE 断联 → 倒计时结束 → 生成 AlertEvent → 网络不可达
- 用户可见症状：守护状态显示"离线队列 N 条待发送"
- 影响范围：Tower 无法接收事件，Contact 无法收到通知
- 检测方式：网络状态监听 + HTTP 错误码 + 队列长度计数
- 缓解与恢复策略：AlertEvent 进入本地 SQLite 队列；网络恢复后自动补发（指数退避）
- 验收方式：
  1. Sentinel 开启守护 → 飞行模式断网 → 触发断联倒计时
  2. 验证队列显示"待发送 1 条"且状态页可见
  3. 恢复网络 → 验证自动补发成功且 Tower 收到事件

**场景 B：Tower 无网通知失败**
- 触发条件：Tower 接收到事件 → SMTP 连接失败 / 无网络
- 用户可见症状：状态页显示"通知投递失败"并提供重试入口
- 影响范围：Contact 无法收到邮件通知
- 检测方式：SMTP 错误捕获 + 投递记录状态
- 缓解与恢复策略：投递记录标记失败；提供手动重试；网络恢复后可重试
- 验收方式：
  1. Tower 配置 SMTP → 断网 → Sentinel 触发事件
  2. 验证状态页显示"投递失败"且错误原因可见
  3. 恢复网络 → 手动重试 → 验证邮件发送成功

### 4.2 FM-N3：应用被系统杀死

**场景：Android 省电策略杀死 Sentinel**
- 触发条件：系统省电策略 / 用户手动清理后台应用
- 用户可见症状：重新打开 App 显示"守护已中断，需重新启动"
- 影响范围：BLE 监控中断，无法检测断联触发报警
- 检测方式：前台服务状态检测 + 应用生命周期监听
- 缓解与恢复策略：权限自检向导必须阻断"开始守护"；提供"一键修复指引"
- 验收方式：
  1. Sentinel 开始守护 → 手动清理后台 → 重新打开 App
  2. 验证显示"守护中断"提示且提供修复指引
  3. 按指引修复后能重新开始守护

### 4.3 FM-U1：权限不足

**场景：关键权限缺失导致功能受限**
- 触发条件：蓝牙/定位/通知/后台运行权限未授权
- 用户可见症状：对应功能页面显示"权限不足"并提供跳转设置入口
- 影响范围：BLE 扫描失败 / 后台守护不稳定 / 无法发送通知
- 检测方式：运行时权限检查 + 权限状态页面
- 缓解与恢复策略：权限自检向导；缺项明确提示与引导；不满足条件不允许开始守护
- 验收方式：
  1. 新安装应用 → 拒绝关键权限 → 尝试开始守护
  2. 验证权限自检页面明确显示缺失权限
  3. 点击修复 → 跳转系统设置 → 授权后能正常开始守护

### 4.4 FM-U3：配置信息不完整

**场景 A：Tower 未配置通知**
- 触发条件：Tower 生成配对二维码但未配置 Email/SMTP
- 用户可见症状：二维码页面与状态页醒目提示"未配置通知，报警无法送达"
- 影响范围：即使收到事件也无法通知 Contact
- 检测方式：通知配置状态检查
- 缓解与恢复策略：允许配对但强提示风险；提供"立即配置"入口
- 验收方式：
  1. Tower 不配置 Email → 生成配对二维码
  2. 验证页面显示风险提示且二维码可生成
  3. Sentinel 配对后触发事件 → Tower 收到但不发送通知

**场景 B：Sentinel 未绑定 BLE 设备**
- 触发条件：Sentinel 尝试开始守护但未选择 BLE 设备
- 用户可见症状："守护中"按钮置灰且提示"请先选择并连接 BLE 设备"
- 影响范围：无法进入守护状态，无法检测断联
- 检测方式：BLE 连接状态检查
- 缓解与恢复策略：阻断开始守护流程；引导到 BLE 设备选择页面
- 验收方式：
  1. Sentinel 未选择 BLE 设备 → 点击"开始守护"
  2. 验证按钮置灰且提示明确
  3. 选择 BLE 设备后按钮变为可点击状态

